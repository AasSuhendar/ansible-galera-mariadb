---
- name: Generate MariaDB configuration galera.cnf
  template:
    src: galera.cnf.j2
    dest: /etc/mysql/conf.d/galera.cnf
    owner: "{{ mariadb_file_owner }}"
    group: "{{ mariadb_file_owner }}"
    mode: 0644

- name: Allow SSH in UFW
  ufw:
    rule: allow
    port: 22
    proto: tcp
  
- name: Allow port for MariaDB with TCP
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  with_items:
    - 3306
    - 4444
    - 4567
    - 4568

- name: Allow port for MariaDB with UDP
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: udp
  with_items:
    - 4567

- name: Status UFW
  shell: ufw status
  register: ufw_status_info

- name: Intiate MariaDB Galera - Boostraping
  shell: galera_new_cluster
  when:
    - primary

- name: Wait For MariaDB Node Service
  wait_for:
    port: "{{ mariadb_port }}"
    timeout: 30
    connect_timeout: 5
    delay: 5
    state: present
  when:
    - primary

